<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Membres D2B1 - Financement</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-800 border-b-4 border-indigo-500 pb-2">
                Gestionnaire de Membres <span class="text-indigo-600">DREAM2BUILD1</span>
            </h1>
            <p class="text-gray-500 mt-2 text-lg">Suivi Personnalisé et Financement du Système</p>
        </header>

        <!-- SEARCH AND MEMBER ID INPUT -->
        <div class="bg-white p-6 rounded-xl shadow-xl mb-8 border-t-4 border-indigo-500">
            <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Rechercher ou Créer un Membre
            </h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="memberIdInput" placeholder="Ex: D2B1-IWN-001" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-base" value="D2B1-IWN-001">
                <button id="searchButton" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md transform hover:scale-[1.01]">
                    Charger / Créer Fiche
                </button>
            </div>
            <p id="statusMessage" class="mt-3 text-sm text-red-600 font-medium"></p>
        </div>

        <!-- MEMBER CARD / FORM -->
        <div id="memberCard" class="bg-white p-8 rounded-xl shadow-2xl transition-opacity duration-500 opacity-0" style="min-height: 400px;" aria-live="polite">

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- 1. IDENTITÉ & PHOTO -->
                <div class="lg:col-span-1 bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h2 class="text-xl font-bold text-indigo-700 mb-6 border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                        Fiche d'Identité
                    </h2>

                    <!-- Photo Upload -->
                    <div class="flex flex-col items-center mb-6">
                        <div class="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden border-4 border-indigo-400 shadow-lg mb-4">
                            <img id="memberPhotoPreview" src="https://placehold.co/128x128/e5e7eb/4b5563?text=Photo" alt="Photo de profil" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/128x128/e5e7eb/4b5563?text=Photo';">
                        </div>
                        <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="previewImage(event)">
                        <button onclick="document.getElementById('photoInput').click()" class="text-sm text-indigo-600 font-semibold hover:text-indigo-800 transition duration-150 px-3 py-1 bg-indigo-100 rounded-full shadow">
                            Changer Photo
                        </button>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <label for="memberIdDisplay" class="block text-xs font-medium text-gray-500">ID du Membre</label>
                            <input type="text" id="memberIdDisplay" readonly class="mt-1 block w-full p-2 border border-gray-300 bg-gray-200 rounded-lg cursor-not-allowed font-mono text-sm">
                        </div>
                        <div>
                            <label for="nom" class="block text-sm font-medium text-gray-700">Nom</label>
                            <input type="text" id="nom" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="prenom" class="block text-sm font-medium text-gray-700">Prénom</label>
                            <input type="text" id="prenom" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="dateNaissance" class="block text-sm font-medium text-gray-700">Date de Naissance</label>
                            <input type="date" id="dateNaissance" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="groupeSanguin" class="block text-sm font-medium text-gray-700">Groupe Sanguin</label>
                            <select id="groupeSanguin" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Sélectionner</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 2. SUIVI FINANCIER (NOUVEAUX CHAMPS) -->
                <div class="lg:col-span-2">
                    <h2 class="text-xl font-bold text-green-700 mb-6 border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M8.433 7.424a1 1 0 111.956.152L8.98 12.55l1.956.152a1 1 0 01-.152 1.956l-4.5-3.5a1 1 0 01.152-1.956l1.956.152L7.38 8.05l-1.956-.152a1 1 0 01.152-1.956l4.5 3.5a1 1 0 01-.152 1.956l-1.956-.152L10 12.55z" />
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v1h2V5zm-2 5a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Informations de Suivi et Financement
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="investedCount" class="block text-sm font-medium text-gray-700">Nombre de Pers. (Investies)</label>
                            <input type="number" id="investedCount" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" value="0" min="0">
                        </div>
                        <div>
                            <label for="paidPeopleCount" class="block text-sm font-medium text-gray-700">Nombre de Pers. (Payées)</label>
                            <input type="number" id="paidPeopleCount" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" value="0" min="0">
                        </div>
                        <div>
                            <label for="totalInvested" class="block text-sm font-medium text-gray-700">Quantité Investie ($)</label>
                            <input type="number" id="totalInvested" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" value="0" min="0" step="0.01">
                        </div>
                        <div>
                            <label for="totalPaid" class="block text-sm font-medium text-gray-700">Somme Totale Payée ($)</label>
                            <input type="number" id="totalPaid" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" value="0" min="0" step="0.01">
                        </div>
                        <div>
                            <label for="transactionCount" class="block text-sm font-medium text-gray-700">Transactions par Personne (Nb)</label>
                            <input type="number" id="transactionCount" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" value="0" min="0">
                        </div>
                        <div>
                            <label for="oneThirdValue" class="block text-sm font-medium text-gray-700">Valeur du Tiers ($)</label>
                            <input type="number" id="oneThirdValue" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" value="0" min="0" step="0.01">
                        </div>
                        <div class="sm:col-span-2 flex items-center p-3 border border-yellow-300 bg-yellow-50 rounded-lg">
                            <input id="systemRelaunch" type="checkbox" class="h-5 w-5 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                            <label for="systemRelaunch" class="ml-3 block text-sm font-medium text-gray-700">
                                Relancement du Système (Après 22 Pers.)
                            </label>
                        </div>
                    </div>

                    <!-- 3. CHAMPS PERSONNALISÉS -->
                    <h3 class="text-xl font-bold text-gray-700 pt-6 border-t mt-6 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-.21-.78-.413-1.2-.589A6.974 6.974 0 008 2c-1.636 0-3.14.59-4.3.15-.3.26-.53.5-.7.83-.2.38-.34.78-.42 1.2A6.974 6.974 0 002 8c0 1.636.59 3.14 1.57 4.3.26.3.5.53.83.7.38.2.78.34 1.2.42A6.974 6.974 0 008 14c1.636 0 3.14-.59 4.3-1.57.3-.26.53-.5.7-.83.2-.38.34-.78.42-1.2A6.974 6.974 0 0014 8c0-1.636-.59-3.14-1.57-4.3.26-.3.5-.53.83-.7.38-.2.78-.34 1.2-.42A6.974 6.974 0 0018 8c0 1.636-.59 3.14-1.57 4.3.3.26.53.5.7.83.2.38.34.78.42 1.2A6.974 6.974 0 0018 8c0-1.636-.59-3.14-1.57-4.3-.3-.26-.53-.5-.7-.83-.2-.38-.34-.78-.42-1.2A6.974 6.974 0 0014 8c0 1.636-.59 3.14-1.57 4.3.3.26.53.5.7.83.2.38.34.78.42 1.2A6.974 6.974 0 0018 8c0-1.636-.59-3.14-1.57-4.3-.3-.26-.53-.5-.7-.83-.2-.38-.34-.78-.42-1.2A6.974 6.974 0 0014 8c0-1.636-.59-3.14-1.57-4.3z" clip-rule="evenodd" />
                        </svg>
                        Champs Personnalisés
                    </h3>
                    <div id="customFieldsContainer" class="space-y-3 mt-4"></div>
                    <button onclick="addCustomField()" class="text-sm text-green-600 font-semibold hover:text-green-800 transition duration-150 px-3 py-1 bg-green-50 rounded-lg flex items-center mt-3 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                        Ajouter un Champ Libre
                    </button>

                    <!-- SAVE BUTTON -->
                    <button id="saveButton" class="w-full mt-8 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-xl transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-green-300">
                        Sauvegarder les Informations
                    </button>
                    <p id="saveMessage" class="mt-3 text-center text-sm font-medium text-gray-600"></p>
                </div>
            </div>
        </div>

        <p class="text-center text-xs text-gray-500 mt-12">
            Propulsé par Firebase Firestore pour la persistance des données. App ID: <span id="displayAppId" class="font-mono"></span>
        </p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Canvas / environment globals (may be undefined)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // __firebase_config might be a JSON string or already an object; handle both safely
        let firebaseConfig = null;
        try {
            if (typeof __firebase_config !== 'undefined') {
                if (typeof __firebase_config === 'string') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else if (typeof __firebase_config === 'object' && __firebase_config !== null) {
                    firebaseConfig = __firebase_config;
                }
            }
        } catch (e) {
            console.warn("Impossible de parser __firebase_config:", e);
            firebaseConfig = null;
        }

        document.getElementById('displayAppId').textContent = appId;
        // optional: reduce Firestore logs in prod, keep as Debug for development if available
        try { setLogLevel('Debug'); } catch (e) { /* ignore if not available */ }

        // State
        let app = null, db = null, auth = null;
        let isAuthCompleted = false;
        let useFirestore = false;
        let currentMemberId = null;
        let photoBase64 = null;
        const localStorageKey = `members-${appId}`;

        // Helper: unified message
        function showMessage(message, type = 'info', targetId = 'statusMessage') {
            const target = document.getElementById(targetId);
            target.textContent = message || '';
            target.className = `mt-3 text-sm font-medium ${type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : type === 'warning' ? 'text-orange-600' : 'text-gray-600'}`;
        }

        // Initialize Firebase if config is present; otherwise fallback to local storage
        try {
            if (firebaseConfig && firebaseConfig.projectId) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                useFirestore = true;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        isAuthCompleted = true;
                        console.log("Authenticated User ID:", user.uid);
                        document.getElementById('memberCard').style.opacity = '1';
                        showMessage("Connecté à Firebase.", 'success');
                        // Do not auto-load a member; wait user action
                    } else {
                        // sign in anonymously or with provided token
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (err) {
                            console.warn("Auth failed:", err);
                            // fallback to local mode
                            useFirestore = false;
                            isAuthCompleted = true;
                            document.getElementById('memberCard').style.opacity = '1';
                            showMessage("Impossible d'authentifier Firebase. Utilisation du stockage local.", 'warning');
                        }
                    }
                });
            } else {
                // No firebase config provided: local fallback
                useFirestore = false;
                isAuthCompleted = true;
                document.getElementById('memberCard').style.opacity = '1';
                showMessage("Aucune configuration Firebase fournie — utilisation du stockage local.", 'warning');
            }
        } catch (error) {
            console.error("Firebase Initialization Failed:", error);
            useFirestore = false;
            isAuthCompleted = true;
            document.getElementById('memberCard').style.opacity = '1';
            showMessage("Erreur d'initialisation Firebase. Utilisation du stockage local.", 'warning');
        }

        // Local storage helpers (fallback when Firestore not available)
        function readLocalMembers() {
            try {
                const raw = localStorage.getItem(localStorageKey);
                return raw ? JSON.parse(raw) : {};
            } catch (e) {
                console.warn("Erreur lecture localStorage:", e);
                return {};
            }
        }
        function writeLocalMembers(obj) {
            try {
                localStorage.setItem(localStorageKey, JSON.stringify(obj));
            } catch (e) {
                console.warn("Erreur écriture localStorage:", e);
            }
        }

        // Compose Firestore doc reference safely (avoids single string paths)
        function getMemberDocRef(id) {
            if (!db) return null;
            // Use segments: 'artifacts' / appId / 'public' / 'data' / 'members' / id
            return doc(db, 'artifacts', appId, 'public', 'data', 'members', id);
        }

        // File to Base64 (simple)
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // Custom fields DOM management
        let customFieldIndex = 0;
        function createCustomFieldElement(key = '', value = '', index) {
            const container = document.createElement('div');
            container.className = 'flex gap-3 items-center';
            container.setAttribute('data-index', index);
            container.innerHTML = `
                <input type="text" class="custom-key p-2 border border-gray-300 rounded-lg flex-1 text-sm" placeholder="Nom du Champ (Ex: Role, Skill)" value="${escapeHtml(key)}">
                <input type="text" class="custom-value p-2 border border-gray-300 rounded-lg flex-2 text-sm" placeholder="Valeur" value="${escapeHtml(value)}">
                <button class="remove-field text-red-500 hover:text-red-700 transition duration-150 p-2 bg-red-50 rounded-full flex-shrink-0 shadow-sm" title="Supprimer le champ">✕</button>
            `;
            container.querySelector('.remove-field').addEventListener('click', () => container.remove());
            document.getElementById('customFieldsContainer').appendChild(container);
        }
        window.addCustomField = () => {
            customFieldIndex++;
            createCustomFieldElement('', '', customFieldIndex);
        };
        function escapeHtml(s='') { return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

        // Event bindings
        document.getElementById('searchButton').addEventListener('click', loadMember);
        document.getElementById('memberIdInput').addEventListener('keypress', (e)=>{ if (e.key === 'Enter') loadMember(); });
        document.getElementById('saveButton').addEventListener('click', saveMember);

        // Load member (Firestore if available, otherwise localStorage)
        async function loadMember() {
            if (!isAuthCompleted) {
                showMessage("Initialisation en cours. Veuillez attendre quelques secondes.", 'warning');
                return;
            }

            const id = (document.getElementById('memberIdInput').value || '').trim().toUpperCase();
            if (!id) {
                showMessage("Veuillez entrer un ID de membre valide.", 'error');
                return;
            }
            currentMemberId = id;
            document.getElementById('memberIdDisplay').value = currentMemberId;
            resetForm(false); // clear fields but keep ID displayed

            if (useFirestore && db) {
                try {
                    const ref = getMemberDocRef(currentMemberId);
                    const docSnap = await getDoc(ref);
                    if (docSnap.exists && docSnap.exists()) {
                        const data = docSnap.data();
                        populateFormFromData(data);
                        showMessage(`Membre "${currentMemberId}" chargé depuis Firestore.`, 'success');
                    } else {
                        showMessage(`ID "${currentMemberId}" non trouvé. Prêt à créer.`, 'warning');
                        // keep cleared form to create a new member
                        document.getElementById('memberIdDisplay').value = currentMemberId;
                    }
                } catch (e) {
                    console.error("Erreur lors du chargement depuis Firestore:", e);
                    showMessage("Erreur: Impossible de charger depuis Firestore. Vérifiez permissions/connexion.", 'error');
                    // fallback: try local
                    const local = readLocalMembers();
                    if (local[currentMemberId]) {
                        populateFormFromData(local[currentMemberId]);
                        showMessage(`Membre "${currentMemberId}" chargé depuis stockage local.`, 'success');
                    }
                }
            } else {
                // Local mode
                const local = readLocalMembers();
                if (local[currentMemberId]) {
                    populateFormFromData(local[currentMemberId]);
                    showMessage(`Membre "${currentMemberId}" chargé depuis stockage local.`, 'success');
                } else {
                    showMessage(`ID "${currentMemberId}" non trouvé localement — prêt à créer.`, 'warning');
                }
            }
        }

        function populateFormFromData(data = {}) {
            document.getElementById('nom').value = data.nom || '';
            document.getElementById('prenom').value = data.prenom || '';
            document.getElementById('dateNaissance').value = data.dateNaissance || '';
            document.getElementById('groupeSanguin').value = data.groupeSanguin || '';

            // financial fields
            document.getElementById('investedCount').value = data.investedCount ?? 0;
            document.getElementById('paidPeopleCount').value = data.paidPeopleCount ?? 0;
            document.getElementById('totalInvested').value = data.totalInvested ?? 0;
            document.getElementById('totalPaid').value = data.totalPaid ?? 0;
            document.getElementById('transactionCount').value = data.transactionCount ?? 0;
            document.getElementById('oneThirdValue').value = data.oneThirdValue ?? 0;
            document.getElementById('systemRelaunch').checked = !!data.systemRelaunch;

            // photo
            photoBase64 = data.photoBase64 || null;
            document.getElementById('memberPhotoPreview').src = photoBase64 || 'https://placehold.co/128x128/e5e7eb/4b5563?text=Photo';

            // custom fields
            document.getElementById('customFieldsContainer').innerHTML = '';
            customFieldIndex = 0;
            if (data.champsPersonnalises) {
                for (const [k,v] of Object.entries(data.champsPersonnalises)) {
                    customFieldIndex++;
                    createCustomFieldElement(k, v, customFieldIndex);
                }
            }
        }

        // Save member (Firestore or local)
        async function saveMember() {
            if (!isAuthCompleted) {
                showMessage("Initialisation en cours. Veuillez attendre...", 'error', 'saveMessage');
                return;
            }
            if (!currentMemberId) {
                showMessage("Veuillez charger ou entrer un ID de membre d'abord.", 'error', 'saveMessage');
                return;
            }

            document.getElementById('saveButton').disabled = true;
            document.getElementById('saveButton').textContent = "Sauvegarde en cours...";

            // Gather data
            const memberData = {
                id: currentMemberId,
                nom: document.getElementById('nom').value.trim(),
                prenom: document.getElementById('prenom').value.trim(),
                dateNaissance: document.getElementById('dateNaissance').value,
                groupeSanguin: document.getElementById('groupeSanguin').value,
                investedCount: Number(document.getElementById('investedCount').value) || 0,
                paidPeopleCount: Number(document.getElementById('paidPeopleCount').value) || 0,
                totalInvested: Number(document.getElementById('totalInvested').value) || 0,
                totalPaid: Number(document.getElementById('totalPaid').value) || 0,
                transactionCount: Number(document.getElementById('transactionCount').value) || 0,
                oneThirdValue: Number(document.getElementById('oneThirdValue').value) || 0,
                systemRelaunch: !!document.getElementById('systemRelaunch').checked,
                photoBase64: photoBase64,
                derniereModification: new Date().toISOString()
            };

            // custom fields
            const customFields = {};
            const containers = document.querySelectorAll('#customFieldsContainer > div');
            containers.forEach(c => {
                const k = (c.querySelector('.custom-key')?.value || '').trim();
                const v = (c.querySelector('.custom-value')?.value || '').trim();
                if (k) customFields[k] = v;
            });
            memberData.champsPersonnalises = customFields;

            // validation
            if (!memberData.nom || !memberData.prenom) {
                showMessage("Le Nom et le Prénom sont obligatoires.", 'error', 'saveMessage');
                document.getElementById('saveButton').disabled = false;
                document.getElementById('saveButton').textContent = "Sauvegarder les Informations";
                return;
            }

            // Save
            if (useFirestore && db) {
                try {
                    const ref = getMemberDocRef(currentMemberId);
                    await setDoc(ref, memberData);
                    showMessage(`Membre "${currentMemberId}" sauvegardé avec succès sur Firestore.`, 'success', 'saveMessage');
                } catch (e) {
                    console.error("Erreur lors de la sauvegarde Firestore:", e);
                    showMessage("Erreur: Impossible de sauvegarder sur Firestore. Tentative de sauvegarde locale.", 'error', 'saveMessage');
                    const all = readLocalMembers();
                    all[currentMemberId] = memberData;
                    writeLocalMembers(all);
                    showMessage(`Membre "${currentMemberId}" sauvegardé localement.`, 'success', 'saveMessage');
                }
            } else {
                const all = readLocalMembers();
                all[currentMemberId] = memberData;
                writeLocalMembers(all);
                showMessage(`Membre "${currentMemberId}" sauvegardé localement.`, 'success', 'saveMessage');
            }

            document.getElementById('saveButton').disabled = false;
            document.getElementById('saveButton').textContent = "Sauvegarder les Informations";
        }

        // Reset form
        function resetForm(clearId = true) {
            document.getElementById('nom').value = '';
            document.getElementById('prenom').value = '';
            document.getElementById('dateNaissance').value = '';
            document.getElementById('groupeSanguin').value = '';

            document.getElementById('investedCount').value = 0;
            document.getElementById('paidPeopleCount').value = 0;
            document.getElementById('totalInvested').value = 0;
            document.getElementById('totalPaid').value = 0;
            document.getElementById('transactionCount').value = 0;
            document.getElementById('oneThirdValue').value = 0;
            document.getElementById('systemRelaunch').checked = false;

            document.getElementById('customFieldsContainer').innerHTML = '';
            customFieldIndex = 0;

            photoBase64 = null;
            document.getElementById('memberPhotoPreview').src = 'https://placehold.co/128x128/e5e7eb/4b5563?text=Photo';
            document.getElementById('saveMessage').textContent = '';

            if (clearId) {
                document.getElementById('memberIdInput').value = '';
                document.getElementById('memberIdDisplay').value = '';
                currentMemberId = null;
            }
        }

        // Image preview & basic size guard
        window.previewImage = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                showMessage("Veuillez choisir une image valide.", 'error', 'saveMessage');
                return;
            }
            if (file.size > 1024 * 500) { // 500KB
                showMessage("Photo trop volumineuse (>500KB). Choisissez une image plus petite.", 'error', 'saveMessage');
                return;
            }
            try {
                const base64 = await fileToBase64(file);
                photoBase64 = base64;
                document.getElementById('memberPhotoPreview').src = base64;
                showMessage("Photo chargée en mémoire. Cliquez sur 'Sauvegarder' pour la stocker.", 'success', 'saveMessage');
            } catch (e) {
                console.error("Erreur conversion image:", e);
                showMessage("Erreur lors du chargement de la photo.", 'error', 'saveMessage');
            }
        };

        // Init: show a single empty custom field so UI isn't empty
        addCustomField();
    </script>
</body>
</html>
